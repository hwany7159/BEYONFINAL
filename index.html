<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Word Blackout Memorizer v23 (ì •ë‹µ ì‹œ ìë™ ë‹¤ìŒ)</title>
  <style>
    :root {
      --bg:#0b1023; --panel:#0f172a; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --blue:#38bdf8; --green:#22c55e; --red:#ef4444; --yellow:#f59e0b;
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#090f1e 0%,#0f172a 50%,#0b1023 100%);
      color:var(--text);
      font-family:System-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,sans-serif;
      font-size:16px; /* iOS ì…ë ¥ í™•ëŒ€ ë°©ì§€ */
    }
    .container{max-width:1100px;margin:0 auto;padding:16px 16px calc(90px + var(--safe-bottom));}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:1024px){.grid{grid-template-columns:360px 1fr}}
    .card{
      background:rgba(15,23,42,.82);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px);
      box-shadow:0 12px 32px rgba(0,0,0,0.45)
    }
    h1{font-size:20px;margin:0 0 10px;letter-spacing:.3px}
    h2{font-size:16px;margin:0 0 8px;color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      background:transparent;color:var(--text);
      border:1px solid var(--border);
      padding:12px 16px;border-radius:12px;cursor:pointer;
      min-height:44px; /* iOS í„°ì¹˜ê¶Œì¥ */
      min-width:44px;
      transition:transform .06s ease, background .2s ease, border-color .2s ease
    }
    .btn:active{transform:scale(.98)}
    .btn.pill{border-radius:9999px}
    .btn.active{background:#0ea5e9;color:#041318;border-color:#0284c7}
    .btn.primary{background:rgba(56,189,248,.12);border-color:rgba(56,189,248,.4)}
    .btn.success{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.32)}
    .btn.warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.32)}
    .btn.cta{background:#22c55e;color:#041318;border-color:#16a34a;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .field{
      width:100%;background:#0b1224;color:#e5e7eb;border:1px solid var(--border);
      border-radius:12px;padding:12px 14px;outline:none;line-height:1.4;
      font-size:16px; /* iOS ì¤Œ ë°©ì§€ */
    }
    textarea.field{min-height:160px;resize:vertical}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px; padding-top:calc(var(--safe-top));}
    .mask{line-height:1.9;font-size:19px;word-wrap:break-word;min-height:120px;user-select:text}
    .token{margin-right:.28ch}.punct{margin-right:0}
    .blackout{background:#000;color:transparent;border-radius:6px;padding:0 .22rem;user-select:none;letter-spacing:.08em}
    .status{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted);margin-top:6px}
    .result{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);display:none}
    .ok{background:rgba(34,197,94,.08)} .no{background:rgba(239,68,68,.08)}
    .hidden{display:none !important}
    .progress{width:100%;height:10px;background:#0b1224;border:1px solid #1f2937;border-radius:9999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#22c55e,#38bdf8);width:0%}
    .pillBadge{font-size:12px;color:#0ea5e9;border:1px solid #0ea5e9;padding:4px 10px;border-radius:9999px}
    .tiny{font-size:12px;color:#94a3b8}
    .banner{padding:10px 12px;border-radius:12px;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.35);color:#86efac;margin-bottom:10px}
    /* í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°”: iOS í‚¤ë³´ë“œ/í™ˆì¸ë””ì¼€ì´í„° íšŒí”¼ */
    .actionbar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(10,14,28,.92);
      border-top:1px solid var(--border);
      padding:10px 12px calc(8px + var(--safe-bottom));
      display:flex;gap:8px;align-items:center;
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
    }
    .actionbar .field{flex:1}
    .actionbar .btn{white-space:nowrap}
    .hint{font-size:12px;color:#9ca3af;margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Word Blackout Memorizer v23 <span class="muted">(iPhone ìµœì í™” Â· ì •ë‹µ ì‹œ ìë™ ë‹¤ìŒ)</span></h1>
      <div class="muted">Enterë¡œ ì±„ì  Â· iOS SafariëŠ” ì›¹ ìŒì„±ì¸ì‹ ë¯¸ì§€ì›(ë„¤ì´í‹°ë¸Œ ë˜í•‘ ê¶Œì¥)</div>
    </div>
    <div id="doneBanner" class="banner hidden">ëª¨ë“  ë¬¸ì¥ì„ ì™„ë£Œí–ˆì–´ìš”! ğŸ‰</div>
    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div id="insecureBanner" class="banner hidden" style="background:rgba(234,179,8,.08);border-color:rgba(234,179,8,.35);color:#fde68a">ë³´ì•ˆë˜ì§€ ì•Šì€ í˜ì´ì§€ì…ë‹ˆë‹¤. ë§ˆì´í¬ ì‚¬ìš©ì„ ìœ„í•´ <b>HTTPS</b> ë˜ëŠ” <b>localhost</b>ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.</div>
        <h2>ì„¤ì •</h2>
        <div class="row" style="margin-bottom:8px">
          <button class="btn pill" data-p="0.3">30%</button>
          <button class="btn pill" data-p="0.5">50%</button>
          <button class="btn pill" data-p="0.8">80%</button>
          <button id="reshuffle" class="btn pill">ë‹¤ì‹œ ì„ê¸°</button>
          <button id="reveal" class="btn pill">ì •ë‹µ ë³´ê¸°</button>
        </div>
        <div class="row" style="margin-bottom:8px">
          <button id="fullMode" class="btn pill active">ì „ì²´ ë¬¸ì¥ ì…ë ¥</button>
          <button id="blanksMode" class="btn pill">ë¹ˆì¹¸ë§Œ ì…ë ¥</button>
          <span id="blanksInfo" class="tiny"></span>
        </div>
        <div id="status" class="status"></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <hr style="border:none;border-top:1px solid var(--border); margin:10px 0">
        <h2>ì§€ë¬¸ ì…ë ¥</h2>
        <div id="editorWrap">
          <textarea id="source" class="field" placeholder="ì—¬ê¸°ì— ì „ì²´ ì§€ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. '.' ê¸°ì¤€ + ì•½ì–´ ì˜ˆì™¸(U.S., Mr., Dr., â€¦)"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="applyStart" class="btn cta">ì ìš© & ì‹œì‘</button>
            <span class="muted">ì‹œì‘í•˜ë©´ ì „ì²´ê¸€ì€ ìˆ¨ê²¨ì§€ê³ , í•œ ë¬¸ì¥ë§Œ ë³´ì…ë‹ˆë‹¤.</span>
          </div>
        </div>
        <div id="lockedWrap" class="hidden">
          <div class="muted">í•™ìŠµ ì¤‘: ì›ë¬¸ì€ ìˆ¨ê¹€. <span id="unlock" style="text-decoration:underline;cursor:pointer">ì›ë¬¸ í¸ì§‘í•˜ê¸°</span> (ì§„í–‰ ì´ˆê¸°í™”)</div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="prev" class="btn" disabled>ì´ì „</button>
            <button id="next" class="btn" title="ì •ë‹µê³¼ ë¬´ê´€í•˜ê²Œ ì´ë™">ë‹¤ìŒ</button>
          </div>
          <div class="row">
            <span id="sentenceBadge" class="pillBadge">ë¬¸ì¥ 0 / 0</span>
            <button id="speakBtn" class="btn" disabled>ë¬¸ì¥ ë“£ê¸°</button>
          </div>
        </div>

        <div id="mask" class="mask" style="margin-top:10px">
          <div class="muted">ì™¼ìª½ì— ì§€ë¬¸ì„ ë¶™ì—¬ë„£ê³  <b>ì ìš© & ì‹œì‘</b>ì„ ëˆ„ë¥´ì„¸ìš”. (í•­ìƒ í˜„ì¬ ë¬¸ì¥ 1ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤)</div>
        </div>

        <div style="margin-top:10px">
          <div class="row">
            <button id="modeType" class="btn pill active" disabled>íƒ€ì´í•‘</button>
            <button id="modeVoice" class="btn pill" disabled>ìŒì„±</button>
          </div>
          <!-- ìŒì„±ë°•ìŠ¤ëŠ” iOS Safariì—ì„œ ìë™ ìˆ¨ê¹€ -->
          <div id="voiceBox" class="hidden" style="margin-top:8px;">
            <div class="row">
              <button id="recStart" class="btn success">ë…¹ìŒ ì‹œì‘</button>
              <button id="recStop" class="btn warn" disabled>ì •ì§€</button>
            </div>
            <div id="recOut" class="muted" style="margin-top:8px"></div>
            <div class="hint">ì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì±„ì ë©ë‹ˆë‹¤.</div>
            <div id="voiceWarn" class="hint" style="color:#fca5a5"></div>
          </div>
          <div id="result" class="result"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°”: ì…ë ¥ + ì£¼ìš” ë²„íŠ¼ -->
  <div class="actionbar" id="actionbar">
    <input id="answer" class="field" inputmode="latin" autocapitalize="off" autocomplete="off" autocorrect="off"
           placeholder="ì—¬ê¸°ì— ë‹µì„ ì…ë ¥í•˜ì„¸ìš” (Enterë¡œ ì œì¶œ)"/>
    <button id="check" class="btn primary">ì±„ì </button>
    <button id="fill" class="btn">ì •ë‹µ ì…ë ¥</button>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
    if (!isSecure) $('insecureBanner').classList.remove('hidden');

    if (isIOS){
      $('modeVoice').classList.add('hidden');
      $('voiceBox').classList.add('hidden');
    }

    $("answer").addEventListener('focus', () => {
      setTimeout(()=>{ window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }); }, 150);
    });

    $("check").addEventListener('focus', () => {
      $("check").style.outline = '2px solid #38bdf8';
      setTimeout(()=> $("check").style.outline = '', 300);
    });

    function splitByDotWithExceptions(text){
      const EXCEPT = new Set(['mr','mrs','ms','dr','prof','sr','jr','st','vs','etc','e.g','i.e','u.s','u.k','u.n']);
      const s = (text||'').replace(/\\s+\\n/g,' ').replace(/\\s{2,}/g,' ').trim();
      const out = []; let buf = '';
      for (let i=0;i<s.length;i++){
        const ch = s[i]; buf += ch;
        if (ch === '.'){
          let k = buf.length - 2; let token = '';
          while (k >= 0 && !/\\s/.test(buf[k])) { token = buf[k] + token; k--; }
          const base = token.replace(/\\.+$/,'').toLowerCase();
          let j = i+1; while (j < s.length && s[j] === ' ') j++;
          const nextCh = s[j] || '';
          const isAbbrev = EXCEPT.has(base) || /^[A-Za-z]$/.test(base);
          const nextLooksSentenceStart = /[A-Z"']/.test(nextCh) || nextCh === '';
          if (isAbbrev && !nextLooksSentenceStart){ continue; } else { out.push(buf.trim()); buf = ''; }
        }
      }
      if (buf.trim().length) { const t = buf.trim(); out.push(/\\.$/.test(t) ? t : t + '.'); }
      return out.filter(Boolean);
    }

    function tokenize(sentence){
      const tokens = sentence.match(/[A-Za-z]+(?:â€™[A-Za-z]+)?|\\d+|[^\\s\\w]/g) || [];
      return tokens.map(t => ({ text: t, isWord: /^[A-Za-z0-9]/.test(t), isPunct: /[^\\s\\w]/.test(t) && !/^[A-Za-z0-9]/.test(t) }));
    }
    function mulberry32(a){ return function(){ var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
    function maskTokens(tokens, percent, seed){
      const idxs = tokens.map((t,i)=>t.isWord?i:-1).filter(i=>i>=0);
      const target = Math.max(1, Math.round(idxs.length*percent));
      const rng = mulberry32(seed || Math.floor(Math.random()*1e9));
      for (let i=idxs.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); const tmp=idxs[i]; idxs[i]=idxs[j]; idxs[j]=tmp; }
      const set = new Set(idxs.slice(0,target));
      return tokens.map((t,i)=> ({...t, masked: t.isWord && set.has(i)}));
    }
    function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
    function normalize(s){ return (s||'').toLowerCase().replace(/[â€œâ€]/g,'"').replace(/[â€˜â€™]/g,"'").replace(/\\s+/g,' ').trim(); }
    function lev(a,b){ a=normalize(a); b=normalize(b);
      const m=a.length,n=b.length, dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c); } }
      return dp[m][n];
    }
    function sim(a,b){ const L=Math.max(normalize(a).length, normalize(b).length)||1; return 1 - (lev(a,b)/L); }

    const maskEl = $("mask"), statusEl = $("status"), bar = $("bar"), badge = $("sentenceBadge");
    const prevBtn = $("prev"), nextBtn = $("next"), speakBtn = $("speakBtn");
    const modeTypeBtn = $("modeType"), modeVoiceBtn = $("modeVoice");
    const answerEl = $("answer"), checkBtn = $("check"), fillBtn = $("fill");
    const applyStart = $("applyStart"), sourceEl = $("source");
    const revealBtn = $("reveal"), reshuffle = $("reshuffle");
    const editorWrap = $("editorWrap"), lockedWrap = $("lockedWrap");
    const fullModeBtn = $("fullMode"), blanksModeBtn = $("blanksMode"), blanksInfo = $("blanksInfo");
    const recStart = $("recStart"), recStop = $("recStop"), recOut = $("recOut"), voiceWarn = $("voiceWarn");
    const resultBox = $("result"); const doneBanner = $("doneBanner");

    let p = 0.3, seed = 42, idx = 0;
    let sentences = [];
    let score = { ok:0, total:0 };
    let started = false;
    let blanksMode = false;
    let currentMaskedWords = [];
    let recObj = null;
    let recBuffer = "";

    function enablePractice(enabled){
      [prevBtn, speakBtn, modeTypeBtn].forEach(b => b.disabled = !enabled);
      if (!isIOS) modeVoiceBtn.disabled = !enabled;
      nextBtn.disabled = !enabled ? true : false; // í•™ìŠµ ì¤‘ í•­ìƒ í™œì„±
    }
    function progressUpdate(){
      const pct = sentences.length ? ((idx) / sentences.length) * 100 : 0;
      bar.style.width = Math.min(100, pct) + '%';
      badge.textContent = `ë¬¸ì¥ ${sentences.length ? (idx+1) : 0} / ${sentences.length}`;
    }
    function render(){
      const s = sentences[idx] || '';
      const toks = tokenize(s);
      const masked = maskTokens(toks, p, seed);
      currentMaskedWords = masked.filter(t=>t.masked && t.isWord).map(t=>t.text);
      maskEl.innerHTML = masked.map(t => t.isPunct ? `<span class="token punct">${escapeHTML(t.text)}</span>`
        : (!t.masked ? `<span class="token">${escapeHTML(t.text)}</span>` : `<span class="token blackout">${escapeHTML(t.text)}</span>`)).join(' ');
      statusEl.innerHTML = `<div>ì§„í–‰: <b>${sentences.length? (idx+1) : 0} / ${sentences.length}</b></div><div>ì ìˆ˜: <b>${score.ok} / ${score.total}</b></div>`;
      resultBox.style.display = "none";
      answerEl.value = '';
      blanksInfo.textContent = blanksMode ? `(ë¹ˆì¹¸ ìˆ˜: ${currentMaskedWords.length}ê°œ)` : '';
      progressUpdate();
      nextBtn.disabled = !started ? true : false;
      doneBanner.classList.add('hidden');
    }
    function setPercent(newP){ p = newP; highlightP(); if (started) render(); }
    function highlightP(){ document.querySelectorAll('[data-p]').forEach(b => b.classList.toggle('active', Number(b.dataset.p) === p)); }
    function updatePlaceholders(){
      if (!blanksMode){
        answerEl.placeholder = "í˜„ì¬ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš” (Enter ì œì¶œ)";
      } else {
        answerEl.placeholder = currentMaskedWords.length
          ? `ê°€ë ¤ì§„ ë‹¨ì–´ ${currentMaskedWords.length}ê°œë¥¼ ìˆœì„œëŒ€ë¡œ ì…ë ¥ (ê³µë°±/ì‰¼í‘œ/ë¬¸ì¥ë¶€í˜¸ êµ¬ë¶„, Enter ì œì¶œ)`
          : "ê°€ë ¤ì§„ ë‹¨ì–´ê°€ ì—†ì–´ìš”. (ê°€ë¦´ ë¹„ìœ¨ì„ ì˜¬ë¦¬ê±°ë‚˜ ë‹¤ì‹œ ì„ê¸°)";
      }
    }
    highlightP();

    document.querySelectorAll('[data-p]').forEach(b => b.addEventListener('click', () => setPercent(Number(b.dataset.p))));
    reshuffle.addEventListener('click', () => { seed = Math.floor(Math.random()*1e9); if (started) render(); });
    revealBtn.addEventListener('click', () => { if (!started) return; p = 0; highlightP(); render(); });

    fullModeBtn.addEventListener('click', () => { blanksMode = false; fullModeBtn.classList.add('active'); blanksModeBtn.classList.remove('active'); updatePlaceholders(); });
    blanksModeBtn.addEventListener('click', () => { blanksMode = true; blanksModeBtn.classList.add('active'); fullModeBtn.classList.remove('active'); updatePlaceholders(); });

    prevBtn.addEventListener('click', () => { if (!started) return; if (idx>0) { idx -= 1; render(); } });
    nextBtn.addEventListener('click', () => { if (!started) return; if (idx < sentences.length-1) { idx += 1; render(); } });

    speakBtn.addEventListener('click', () => {
      if (!started) return;
      try{
        const u=new SpeechSynthesisUtterance(sentences[idx]||''); u.lang='en-US'; u.rate=0.95;
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch(e){ alert('ì´ ê¸°ê¸°ì—ì„œ ìŒì„± ì¶œë ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); }
    });

    applyStart.addEventListener('click', () => {
      const raw = sourceEl.value || '';
      const sents = splitByDotWithExceptions(raw);
      if (!sents.length) { alert("ì§€ë¬¸ì´ ë¹„ì–´ ìˆê±°ë‚˜ '.'ì´ ì—†ìŠµë‹ˆë‹¤. '.'ìœ¼ë¡œ ë¬¸ì¥ì„ êµ¬ë¶„í•´ ì£¼ì„¸ìš”."); return; }
      sentences = sents; idx = 0; score = { ok:0, total:0 }; started = true;
      editorWrap.classList.add('hidden'); lockedWrap.classList.remove('hidden');
      enablePractice(true); render();
      modeTypeBtn.classList.add('active');
      if (!isIOS){ modeVoiceBtn.classList.remove('active'); }
      updatePlaceholders();
      setTimeout(()=> $('answer').focus(), 50);
    });

    $("unlock").addEventListener('click', () => {
      started = false; enablePractice(false);
      editorWrap.classList.remove('hidden'); lockedWrap.classList.add('hidden');
      maskEl.innerHTML = '<div class="muted">ì™¼ìª½ì— ì§€ë¬¸ì„ ë¶™ì—¬ë„£ê³  <b>ì ìš© & ì‹œì‘</b>ì„ ëˆ„ë¥´ì„¸ìš”. (í•­ìƒ í˜„ì¬ ë¬¸ì¥ 1ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤)</div>';
      statusEl.innerHTML = ''; bar.style.width = '0%'; $("sentenceBadge").textContent='ë¬¸ì¥ 0 / 0';
      answerEl.value=''; resultBox.style.display='none';
    });

    function showResult(ok, msgHTML){
      resultBox.className = 'result ' + (ok?'ok':'no');
      resultBox.style.display = 'block';
      resultBox.innerHTML = msgHTML;
    }
    function checkAnswerFull(text){
      const truth = sentences[idx] || '';
      const s = sim(text, truth);
      const ok = s >= 0.9;
      const html = `<div>ìœ ì‚¬ë„: <b>${Math.round(s*100)}%</b></div>` + (ok ? '' : `<div style="margin-top:6px">ì •ë‹µ: <b>${escapeHTML(truth)}</b></div>`);
      return {ok, html};
    }
    function splitAnswerWords(text){
      return (text || '').trim().split(/[^\p{L}\p{N}'â€™]+/u).filter(Boolean);
    }
    function wordSim(a,b){
      a = (a||'').replace(/[^A-Za-z0-9']/g,'').toLowerCase();
      b = (b||'').replace(/[^A-Za-z0-9']/g,'').toLowerCase();
      if (!a && !b) return 1; if (!a || !b) return 0;
      const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c); } }
      return 1 - dp[m][n] / Math.max(m,n);
    }
    function checkAnswerBlanks(text){
      const s = sentences[idx];
      const toks = tokenize(s);
      const masked = maskTokens(toks, p, seed);
      const truthWords = masked.filter(t=>t.masked && t.isWord).map(t=>t.text);
      const ansWords = splitAnswerWords(text);
      if (truthWords.length === 0){
        return { ok:false, html:`<div>ì´ ë¬¸ì¥ì—ëŠ” ê°€ë ¤ì§„ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ê°€ë¦´ ë¹„ìœ¨ì„ ì˜¬ë¦¬ê±°ë‚˜ <b>ë‹¤ì‹œ ì„ê¸°</b>ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>` };
      }
      if (ansWords.length !== truthWords.length){
        const html = `<div>ë‹¨ì–´ ê°œìˆ˜ê°€ ë‹¬ë¼ìš”: <b>${ansWords.length}</b>ê°œ ì…ë ¥ / í•„ìš” <b>${truthWords.length}</b>ê°œ</div>
                      <div class="tiny" style="margin-top:6px">íŒíŠ¸: ê³µë°±/ì‰¼í‘œ/ë¬¸ì¥ë¶€í˜¸ë¡œ ë‹¨ì–´ë¥¼ êµ¬ë¶„í•´ ì£¼ì„¸ìš”.</div>`;
        return { ok:false, html };
      }
      let allOk = true; let rows = [];
      for (let k=0;k<truthWords.length;k++){
        const sc = wordSim(ansWords[k], truthWords[k]);
        const hit = sc >= 0.85;
        allOk = allOk && hit;
        rows.push(`<tr><td>${k+1}</td><td>${escapeHTML(truthWords[k])}</td><td>${escapeHTML(ansWords[k])}</td><td>${Math.round(sc*100)}%</td></tr>`);
      }
      const html = (allOk
        ? `<div>ì •ë‹µ! (ë¹ˆì¹¸ ${truthWords.length}ê°œ ëª¨ë‘ ì¼ì¹˜)</div>`
        : `<div>ì¼ë¶€ ë‹¨ì–´ê°€ ë‹¬ë¼ìš”.</div>`) +
        `<div style="overflow:auto"><table style="border-collapse:collapse;margin-top:8px;font-size:13px">
          <thead><tr><th style="padding:4px 8px;border-bottom:1px solid #334155;text-align:left">#</th>
          <th style="padding:4px 8px;border-bottom:1px solid #334155;text-align:left">ì •ë‹µ</th>
          <th style="padding:4px 8px;border-bottom:1px solid #334155;text-align:left">ì…ë ¥</th>
          <th style="padding:4px 8px;border-bottom:1px solid #334155;text-align:left">ìœ ì‚¬ë„</th></tr></thead>
          <tbody>${rows.join('')}</tbody></table></div>`;
      return { ok: allOk, html };
    }
    function checkAnswer(text){
      if (!started) return;
      const res = (!blanksMode) ? checkAnswerFull(text) : checkAnswerBlanks(text);
      score.total += 1; if (res.ok) score.ok += 1;
      showResult(res.ok, res.html);
      statusEl.innerHTML = `<div>ì§„í–‰: <b>${idx+1} / ${sentences.length}</b></div><div>ì ìˆ˜: <b>${score.ok} / ${score.total}</b></div>`;
      // === ì •ë‹µì´ë©´ ìë™ ë‹¤ìŒ ===
      if (res.ok){
        setTimeout(()=>{
          if (idx < sentences.length - 1){
            idx += 1; render();
          } else {
            doneBanner.classList.remove('hidden');
          }
          $('answer').focus();
        }, 550);
      } else {
        // ì˜¤ë‹µì´ë©´ ì…ë ¥ì°½ì— ë°”ë¡œ í¬ì»¤ìŠ¤
        setTimeout(()=> $('answer').focus(), 0);
      }
    }
    // ì „ì—­ ë…¸ì¶œ (Capacitor ë„¤ì´í‹°ë¸Œ ì–´ëŒ‘í„°ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
    window.checkAnswer = checkAnswer;

    // ì œì¶œ: Enter ë˜ëŠ” 'ì±„ì ' ë²„íŠ¼
    answerEl.addEventListener('keydown', (e) => { if (e.key === 'Enter'){ e.preventDefault(); checkAnswer(answerEl.value); } });
    checkBtn.addEventListener('click', () => checkAnswer(answerEl.value));
    fillBtn.addEventListener('click', () => { if (!started) return; answerEl.value = sentences[idx] || ''; answerEl.focus(); });

    // ===== ìŒì„± ì¸ì‹ (iOSëŠ” ë¯¸ì§€ì›, Android Chrome ë“±ì—ì„œë§Œ ë…¸ì¶œ) =====
    function stopRec(submit){
      try { if (recObj) recObj.stop(); } catch(_) {}
      if (submit){
        const text = (recBuffer || '').trim().replace(/\\s+/g,' ');
        if (text) checkAnswer(text);
        else if (voiceWarn) voiceWarn.textContent = 'ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
      }
    }
    function startRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { if (voiceWarn) voiceWarn.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì›¹ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
      if (!isSecure) { if (voiceWarn) voiceWarn.textContent = 'HTTPS ë˜ëŠ” localhostì—ì„œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.'; return; }
      recObj = new SR();
      recObj.lang = 'en-US'; recObj.continuous = true; recObj.interimResults = false;
      recBuffer = ""; if (recOut) recOut.textContent = 'ë“£ëŠ” ì¤‘...';
      recObj.onresult = (e) => {
        for (let i=e.resultIndex; i<e.results.length; i++){
          const r = e.results[i];
          if (r.isFinal){
            const chunk = (r[0].transcript || '').trim();
            if (chunk){ recBuffer = (recBuffer + ' ' + chunk).trim().replace(/\\s+/g,' '); }
          }
        }
        if (recOut) recOut.textContent = `ì¸ì‹: "${recBuffer}"`;
      };
      recObj.onerror = (ev) => { if (voiceWarn) voiceWarn.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + (ev && ev.error || 'unknown'); stopRec(true); };
      recObj.onend = () => { stopRec(true); };
      recObj.start();
    }
    if (!isIOS){
      $('modeVoice').disabled = true; // ì‹œì‘ ì „ì—” ë¹„í™œì„±
      $('modeVoice').addEventListener('click', () => {
        if (!started) return;
        $('voiceBox').classList.remove('hidden');
        startRecognition();
      });
      if ($('recStart')) $('recStart').addEventListener('click', startRecognition);
      if ($('recStop')) $('recStop').addEventListener('click', () => stopRec(true));
    }

    // ì´ˆê¸° ìƒíƒœ
    (function init(){
      statusEl.innerHTML = '';
      maskEl.innerHTML = '<div class="muted">ì™¼ìª½ì— ì§€ë¬¸ì„ ë¶™ì—¬ë„£ê³  <b>ì ìš© & ì‹œì‘</b>ì„ ëˆ„ë¥´ì„¸ìš”. (í•­ìƒ í˜„ì¬ ë¬¸ì¥ 1ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤)</div>';
      nextBtn.disabled = true; // ì‹œì‘ ì „ ë¹„í™œì„±
    })();
  </script>

  <!-- (ì„ íƒ) Capacitor ë„¤ì´í‹°ë¸Œ ì–´ëŒ‘í„°: ë³„ë„ íŒŒì¼ì—ì„œ ë¶™ì—¬ë„ ë¨ -->
  <script>
  (async function(){
    const isCap = !!(window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform());
    const Plugins = window.Capacitor && window.Capacitor.Plugins;
    const SR = Plugins && Plugins.SpeechRecognition;
    if (!isCap || !SR) return;
    // iOSë„ ìŒì„± ë²„íŠ¼/ìƒì ë…¸ì¶œ
    const vb = document.getElementById('voiceBox'); const mv = document.getElementById('modeVoice');
    if (mv) mv.classList.remove('hidden'); if (vb) vb.classList.remove('hidden');
    try { await SR.requestPermission(); } catch(e){ console.log(e); }
    mv && mv.addEventListener('click', async () => {
      try {
        const voiceWarn = document.getElementById('voiceWarn'); const recOut = document.getElementById('recOut');
        if (voiceWarn) voiceWarn.textContent = '';
        if (recOut) recOut.textContent = 'ë“£ëŠ” ì¤‘...';
        await SR.start({ language: 'en-US', popup: true, partialResults: true });
      } catch(e){ const voiceWarn = document.getElementById('voiceWarn'); if (voiceWarn) voiceWarn.textContent = 'ìŒì„± ì‹œì‘ ì‹¤íŒ¨: ' + (e.message||e); }
    });
    SR.addListener && SR.addListener('result', (data) => {
      const text = (data && (data.matches?.[0] || data.text || '')).trim();
      const recOut = document.getElementById('recOut');
      if (recOut) recOut.textContent = `ì¸ì‹: "${text}"`;
      if (text) { if (typeof window.checkAnswer === 'function') window.checkAnswer(text); }
    });
    SR.addListener && SR.addListener('partialResults', (data) => {
      const text = (data && (data.value?.[0] || data.matches?.[0] || '')).trim();
      const recOut = document.getElementById('recOut');
      if (recOut && text) recOut.textContent = `ì¸ì‹: "${text}"`;
    });
  })();
  </script>
</body>
</html>
